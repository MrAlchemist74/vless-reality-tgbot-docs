# Runbook (операционные процедуры)

## 1) Базовая проверка “сервис недоступен”
**Симптомы:** жалобы пользователей, `/health` ❌, рост e2e-latency.  
**Шаги:**
1. Проверить последние алерты (время/частота).
2. Проверить, что заданы и актуальны `UUID/PBK/SID/PORT/SNI/FP/FLOW`.
3. **Прогнать e2e-проверку** встроенным тест-клиентом бота (валидные `pbk/sid/fp/flow`).
4. Проверить сетевые правила VPS (inbound для порта Xray; outbound разрешён).
5. Перезапустить сервисы (Compose/systemd); оценить восстановление.
6. При рецидиве — открыть инцидент (см. ниже).

## 2) Высокая задержка (медленный коннект)
1. Сравнить e2e-latency с историческими p95/p99.
2. Проверить провайдера VPS, CPU/сеть, возможные внешние блокировки.
3. При необходимости временно переключиться на резервный порт/ноду.

## 3) Ротация реквизитов (UUID/PBK/SID)
1. Сгенерировать новые значения.
2. Обновить секреты в окружении/Secret Manager.
3. Выпустить уведомление пользователям (шаблон ниже); выдержать период параллельной работы.
4. Деактивировать старые значения; зафиксировать изменения.

**Шаблон уведомления:**  
> Плановая ротация ключей доступа. Новые реквизиты доступны через бота `/creds`. Старые отключатся через 24 часа.

## 4) Инциденты
- **Критерий:** e2e-доступность < 99.5%/сутки **или** e2e-p95 > 300 мс в рабочий интервал.
- **Действия:** объявить инцидент, назначить ответственного, завести карточку/лог; апдейты каждые 30–60 мин.
- **Разбор:** в течение 48 часов — пост-морем (что/почему/как исключить), задачи в Roadmap.

## 5) Изменения/релизы
- Любые изменения конфигурации — по чек-листу: валидация секретов, бэкап текущих значений, окно отката, smoke-e2e.

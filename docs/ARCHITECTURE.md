# Архитектура

## Краткое описание дизайна

**Компоненты:**
- **Xray (VLESS + Reality)** — приём входящих соединений; маскировка через **SNI на публичный хост**; шифрование/поток Vision.
- **Telegram-бот (aiogram)** — выдаёт пользователю строку подключения (`vless://…`), формируемую из параметров (UUID, PBK, SID, SNI, FP, FLOW и обязательных query-параметров); выполняет **e2e-health-checks** (пробное рукопожатие VLESS+Reality+Vision) и шлёт алерты. ICMP-пинг — опциональная справочная метрика.
- **Docker Compose** — оркестрация двух контейнеров; политики рестартов; передача переменных окружения.

**Операционная логика (без кода):**
- Запрос реквизитов → бот формирует `vless://…` ссылку **на основе переменных окружения/секрет-хранилища**.
- Проверки здоровья → бот по расписанию/по команде выполняет **e2e-рукопожатие** к `XRAY_HOST:XRAY_PORT` с валидными `pbk/sid/fp/flow`; замеряет e2e-latency; при сбоях — алерт.
- Журналы → минимально необходимые, без чувствительных данных и **без коррелируемых комбинаций** параметров.

---

## Компоненты и ответственность
- **Xray (VLESS + Reality)**  
  Принимает входящие соединения; маскировка через SNI на публичный хост-декой; управляет шифрованием/потоком (Vision).
- **Telegram-бот (aiogram)**  
  Выдаёт реквизиты (`vless://…`) из параметров (UUID, SNI, PBK, SID, FP, FLOW, порт и обязательные query-параметры).  
  Выполняет **e2e-health-checks** (рукопожатие VLESS+Reality), считает e2e-latency, отправляет уведомления о сбоях.
- **Docker Compose**  
  Запускает два контейнера, задаёт политику рестартов, изолирует сеть, передаёт env-переменные.

## Потоки данных
Пользователь → Telegram → **бот** → (команда `/creds`) → **сбор параметров из env/секретов** → ответ с `vless://…`  
Пользователь → Telegram → **бот** → (команда `/health`) → **e2e-рукопожатие VLESS+Reality** → ответ с состоянием/e2e-latency  
Алерты: **бот** → Telegram (админ-чат/личка)

## Границы и интеграции
- Публичная сеть → Xray (входящий порт; TCP. UDP — см. примечание про XUDP/альтернативы).
- Внутренняя сеть Compose → бот ↔ Xray (TCP).
- Секреты: только env.

## Наблюдаемость (минимум)
- Логи: уровни info/warn/error, без PII и **без** `UUID/PBK/SID/FP/SNI` в одной записи.
- Метрики (по возможности): число успешных/неуспешных **e2e-проверок**, e2e-latency p50/p95/p99, аптайм бота.

---

## Формат `vless://` URI (для совместимости клиентов)

**Обязательные элементы:**
- Схема: `vless://<UUID>@<HOST>:<PORT>`
- Query:
  - `type=tcp`
  - `security=reality`
  - `encryption=none` (для VLESS)
  - `sni=<публичный_хост-декой>`
  - `fp=<chrome|safari|randomized|…>` (fingerprint)
  - `pbk=<PUBLIC_KEY>`
  - `sid=<SHORT_ID>`
  - `flow=xtls-rprx-vision` (если используете Vision)

**Пример (плейсхолдеры):**
```
vless://<UUID>@<HOST>:<PORT>?type=tcp&security=reality&encryption=none&sni=www.youtube.com&fp=chrome&pbk=<PBK>&sid=<SID>&flow=xtls-rprx-vision#MyVPN
```
